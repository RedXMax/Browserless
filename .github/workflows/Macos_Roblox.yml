name: Add macOS Admin User, Enable VNC, and Build Playit with SSHx

on:
  workflow_dispatch:

jobs:
  setup-remote-access:
    name: Create Admin User, Enable ARD/VNC, Build Playit, and Run SSHx
    runs-on: namespace-profile-test

    steps:
      - name: Step 1 â€” Create user "rohit"
        continue-on-error: true
        run: |
          sudo sysadminctl -addUser rohit -password admin

      - name: Step 2 â€” Add user "rohit" to admin group
        continue-on-error: true
        run: |
          sudo dseditgroup -o edit -a rohit -t user admin

      - name: Step 3 â€” Verify user privileges
        continue-on-error: true
        run: |
          id rohit
          dseditgroup -o checkmember -m rohit admin

      - name: Step 4 â€” Enable ARD and configure VNC access
        continue-on-error: true
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw admin \
            -allowAccessFor -specifiedUsers \
            -users rohit \
            -restart -agent

      # ðŸ†• Added steps to build Playit agent before SSHx
      - name: Step 5 â€” Install Rust toolchain
        continue-on-error: true
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source $HOME/.cargo/env

      - name: Step 6 â€” Clone and build Playit agent
        continue-on-error: true
        run: |
          git clone https://github.com/playit-cloud/playit-agent.git
          cd playit-agent
          cargo build --release
          echo "âœ… Playit built successfully."

      - name: Step 7 â€” Add playit-cli to global PATH
        continue-on-error: true
        run: |
          sudo mv playit-agent/target/release/playit-cli /usr/local/bin/playit
          sudo chmod +x /usr/local/bin/playit
          echo "âœ… Playit added to global PATH."
          which playit
          playit --version || echo "Playit ready to run"

      - name: Step 8 â€” Start SSHx remote shell session
        continue-on-error: true
        timeout-minutes: 355
        run: |
          curl -sSf https://sshx.io/get | sh -s run
